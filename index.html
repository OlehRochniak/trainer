<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Wort Trainer</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      height: 100vh;
      text-align: center;
      gap: 1em;
    }
    #word {
      font-size: 6em;
      margin-bottom: 0.5em;
    }
    #translation {
      font-size: 1.5em;
      opacity: 0.7;
    }
    #log {
      font-size: 0.8em;
      color: #888;
    }
    #repeatControl {
      font-size: 1em;
      padding: 0.5em 1em;
      border-radius: 0.5em;
      border: none;
      background: #222;
      color: #fff;
      cursor: pointer;
    }
    #repeatControl option {
      background: #222;
    }
  </style>
</head>
<body>
  <select id="repeatControl">
    <option value="0">–ü–æ–≤—Ç–æ—Ä—è—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ</option>
    <option value="1">1 —Ä–∞–∑</option>
    <option value="5">5 —Ä–∞–∑</option>
    <option value="10">10 —Ä–∞–∑</option>
  </select>

  <div id="word">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  <div id="translation"></div>
  <div id="log"></div>
  <audio id="player"></audio>

  <script>
    const order = [
      "GER Amala",
      "GER Conrad",
      "RUS Dmitry",
      "GER Katja",
      "GER Seraphina",
      "RUS Svetlana",
      "GER Florian"
    ];

    const pauseDuration = 500; // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –≥–æ–ª–æ—Å–∞–º–∏ (–º—Å)

    let entries = [];
    let currentIndex = 0;
    let isPlaying = false;
    let isPaused = false;
    let subIndex = 0;
    let repetitionCount = 0;

    const wordDiv = document.getElementById("word");
    const translationDiv = document.getElementById("translation");
    const logDiv = document.getElementById("log");
    const audio = document.getElementById("player");
    const repeatControl = document.getElementById("repeatControl");

    function log(msg) {
      console.log(msg);
      logDiv.textContent = msg;
    }

    function initApp() {
      fetch("info.txt")
        .then(res => {
          if (!res.ok) throw new Error("–§–∞–π–ª info.txt –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è");
          return res.text();
        })
        .then(text => {
          const lines = text.split("\n");
          entries = lines.map((line, index) => {
            const parts = line.split("\t");
            if (parts.length < 3) {
              log(`‚ö†Ô∏è –°—Ç—Ä–æ–∫–∞ ${index + 1} –Ω–µ–≤–µ—Ä–Ω–∞: "${line}"`);
              return null;
            }
            return {
              filename: parts[0].trim(),
              german: parts[1].trim(),
              translation: parts[2].trim()
            };
          }).filter(Boolean);

          if (entries.length === 0) {
            log("‚ùå –ù–∏ –æ–¥–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ info.txt –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
          } else {
            log("üëÜ –ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É –¥–ª—è —Å—Ç–∞—Ä—Ç–∞...");
            window.addEventListener("keydown", startFirstEntry, { once: true });
          }
        })
        .catch(err => log(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`));
    }

    function startFirstEntry() {
      log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${entries.length} –∑–∞–ø–∏—Å–µ–π`);
      setupControls();
      playEntry(entries[currentIndex]);
    }

    function playEntry(entry) {
      isPlaying = true;
      wordDiv.textContent = entry.german;
      translationDiv.textContent = entry.translation;
      subIndex = 0;
      repetitionCount = 0;
      playNextVoice(entry);
    }

    function playNextVoice(entry) {
      if (!isPlaying || isPaused) return;
      const folder = order[subIndex % order.length];
      const path = `sound/${folder}/${entry.filename}`;
      log(`üîä –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ: ${path}`);
      audio.src = path;
      audio.play().catch(err => log(`‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: ${err.message}`));

      audio.onended = () => {
        setTimeout(() => {
          if (!isPlaying || isPaused) return;
          subIndex++;

          if (subIndex >= order.length) {
            subIndex = 0;
            repetitionCount++;
            const repeatLimit = parseInt(repeatControl.value);

            if (repeatLimit !== 0 && repetitionCount >= repeatLimit) {
              handleNext();
              return;
            }
          }

          playNextVoice(entry);
        }, pauseDuration);
      };
    }

    function setupControls() {
      window.addEventListener("keydown", (e) => {
        if (e.code === "ArrowRight") {
          currentIndex = (currentIndex + 1) % entries.length;
          playEntry(entries[currentIndex]);
        } else if (e.code === "ArrowLeft") {
          currentIndex = (currentIndex - 1 + entries.length) % entries.length;
          playEntry(entries[currentIndex]);
        } else if (e.code === "Space") {
          isPaused = !isPaused;
          if (!isPaused) {
            log("‚ñ∂Ô∏è –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–æ");
            playNextVoice(entries[currentIndex]);
          } else {
            log("‚è∏ –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ (–Ω–∞–∂–º–∏—Ç–µ –ø—Ä–æ–±–µ–ª, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å)");
          }
        }
      });
    }

    function handleNext() {
      currentIndex = (currentIndex + 1) % entries.length;
      playEntry(entries[currentIndex]);
    }

    // –ó–∞–ø—É—Å–∫
    initApp();
  </script>
</body>
</html>